<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
    <title>Coverage for skmob/models/markov_diary_generator.py: 96%</title>
    <link rel="icon" sizes="32x32" href="favicon_32.png">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.hotkeys.js"></script>
    <script type="text/javascript" src="jquery.isonscreen.js"></script>
    <script type="text/javascript" src="coverage_html.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(coverage.pyfile_ready);
    </script>
</head>
<body class="pyfile">
<div id="header">
    <div class="content">
        <h1>Coverage for <b>skmob/models/markov_diary_generator.py</b> :
            <span class="pc_cov">96%</span>
        </h1>
        <img id="keyboard_icon" src="keybd_closed.png" alt="Show keyboard shortcuts" />
        <h2 class="stats">
            170 statements &nbsp;
            <button type="button" class="run shortkey_r button_toggle_run" title="Toggle lines run">163 run</button>
            <button type="button" class="mis show_mis shortkey_m button_toggle_mis" title="Toggle lines missing">7 missing</button>
            <button type="button" class="exc show_exc shortkey_x button_toggle_exc" title="Toggle lines excluded">0 excluded</button>
        </h2>
    </div>
</div>
<div class="help_panel">
    <img id="panel_icon" src="keybd_open.png" alt="Hide keyboard shortcuts" />
    <p class="legend">Hot-keys on this page</p>
    <div>
    <p class="keyhelp">
        <span class="key">r</span>
        <span class="key">m</span>
        <span class="key">x</span>
        <span class="key">p</span> &nbsp; toggle line displays
    </p>
    <p class="keyhelp">
        <span class="key">j</span>
        <span class="key">k</span> &nbsp; next/prev highlighted chunk
    </p>
    <p class="keyhelp">
        <span class="key">0</span> &nbsp; (zero) top of page
    </p>
    <p class="keyhelp">
        <span class="key">1</span> &nbsp; (one) first highlighted chunk
    </p>
    </div>
</div>
<div id="source">
    <p id="t1" class="run"><span class="n"><a href="#t1">1</a></span><span class="t"><span class="key">import</span> <span class="nam">datetime</span>&nbsp;</span><span class="r"></span></p>
    <p id="t2" class="run"><span class="n"><a href="#t2">2</a></span><span class="t"><span class="key">from</span> <span class="nam">tqdm</span> <span class="key">import</span> <span class="nam">tqdm</span>&nbsp;</span><span class="r"></span></p>
    <p id="t3" class="run"><span class="n"><a href="#t3">3</a></span><span class="t"><span class="key">import</span> <span class="nam">operator</span>&nbsp;</span><span class="r"></span></p>
    <p id="t4" class="run"><span class="n"><a href="#t4">4</a></span><span class="t"><span class="key">from</span> <span class="nam">collections</span> <span class="key">import</span> <span class="nam">defaultdict</span><span class="op">,</span> <span class="nam">Counter</span>&nbsp;</span><span class="r"></span></p>
    <p id="t5" class="run"><span class="n"><a href="#t5">5</a></span><span class="t"><span class="key">import</span> <span class="nam">pandas</span> <span class="key">as</span> <span class="nam">pd</span>&nbsp;</span><span class="r"></span></p>
    <p id="t6" class="run"><span class="n"><a href="#t6">6</a></span><span class="t"><span class="key">import</span> <span class="nam">numpy</span> <span class="key">as</span> <span class="nam">np</span>&nbsp;</span><span class="r"></span></p>
    <p id="t7" class="run"><span class="n"><a href="#t7">7</a></span><span class="t"><span class="key">from</span> <span class="op">.</span><span class="op">.</span><span class="nam">utils</span> <span class="key">import</span> <span class="nam">constants</span>&nbsp;</span><span class="r"></span></p>
    <p id="t8" class="run"><span class="n"><a href="#t8">8</a></span><span class="t"><span class="key">import</span> <span class="nam">random</span>&nbsp;</span><span class="r"></span></p>
    <p id="t9" class="pln"><span class="n"><a href="#t9">9</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t10" class="run"><span class="n"><a href="#t10">10</a></span><span class="t"><span class="nam">latitude</span> <span class="op">=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">LATITUDE</span>&nbsp;</span><span class="r"></span></p>
    <p id="t11" class="run"><span class="n"><a href="#t11">11</a></span><span class="t"><span class="nam">longitude</span> <span class="op">=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">LONGITUDE</span>&nbsp;</span><span class="r"></span></p>
    <p id="t12" class="run"><span class="n"><a href="#t12">12</a></span><span class="t"><span class="nam">date_time</span> <span class="op">=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">DATETIME</span>&nbsp;</span><span class="r"></span></p>
    <p id="t13" class="run"><span class="n"><a href="#t13">13</a></span><span class="t"><span class="nam">user_id</span> <span class="op">=</span> <span class="nam">constants</span><span class="op">.</span><span class="nam">UID</span>&nbsp;</span><span class="r"></span></p>
    <p id="t14" class="pln"><span class="n"><a href="#t14">14</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t15" class="pln"><span class="n"><a href="#t15">15</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t16" class="run"><span class="n"><a href="#t16">16</a></span><span class="t"><span class="key">class</span> <span class="nam">MarkovDiaryGenerator</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t17" class="pln"><span class="n"><a href="#t17">17</a></span><span class="t">    <span class="str">"""Markov Diary Learner and Generator.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t18" class="pln"><span class="n"><a href="#t18">18</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t19" class="pln"><span class="n"><a href="#t19">19</a></span><span class="t"><span class="str">    A diary generator :math:`G` produces a mobility diary, :math:`D(t)`, containing the sequence of trips made by an agent during a time period divided in time slots of :math:`t` seconds. For example, :math:`G(3600)` and :math:`G(60)` produce mobility diaries with temporal resolutions of one hour and one minute, respectively [PS2018]_. </span>&nbsp;</span><span class="r"></span></p>
    <p id="t20" class="pln"><span class="n"><a href="#t20">20</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t21" class="pln"><span class="n"><a href="#t21">21</a></span><span class="t"><span class="str">    A Mobility Diary Learner (MDL) is a data-driven algorithm to compute a mobility diary :math:`MD` from the mobility trajectories of a set of real individuals. We use a Markov model to describe the probability that an individual follows her routine and visits a typical location at the usual time, or she breaks the routine and visits another location. First, MDL translates mobility trajectory data of real individuals into abstract mobility trajectories. Second, it uses the obtained abstract trajectory data to compute the transition probabilities of the Markov model :math:`MD(t)` [PS2018]_.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t22" class="pln"><span class="n"><a href="#t22">22</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t23" class="pln"><span class="n"><a href="#t23">23</a></span><span class="t"><span class="str">    Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t24" class="pln"><span class="n"><a href="#t24">24</a></span><span class="t"><span class="str">    ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t25" class="pln"><span class="n"><a href="#t25">25</a></span><span class="t"><span class="str">    name : str, optional</span>&nbsp;</span><span class="r"></span></p>
    <p id="t26" class="pln"><span class="n"><a href="#t26">26</a></span><span class="t"><span class="str">        name of the instantiation of the class. The default is "Markov diary".</span>&nbsp;</span><span class="r"></span></p>
    <p id="t27" class="pln"><span class="n"><a href="#t27">27</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t28" class="pln"><span class="n"><a href="#t28">28</a></span><span class="t"><span class="str">    Attributes</span>&nbsp;</span><span class="r"></span></p>
    <p id="t29" class="pln"><span class="n"><a href="#t29">29</a></span><span class="t"><span class="str">    ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t30" class="pln"><span class="n"><a href="#t30">30</a></span><span class="t"><span class="str">    name : str</span>&nbsp;</span><span class="r"></span></p>
    <p id="t31" class="pln"><span class="n"><a href="#t31">31</a></span><span class="t"><span class="str">        name of the instantiation of the class. </span>&nbsp;</span><span class="r"></span></p>
    <p id="t32" class="pln"><span class="n"><a href="#t32">32</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t33" class="pln"><span class="n"><a href="#t33">33</a></span><span class="t"><span class="str">    markov_chain_ : dict</span>&nbsp;</span><span class="r"></span></p>
    <p id="t34" class="pln"><span class="n"><a href="#t34">34</a></span><span class="t"><span class="str">        the trained markov chain.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t35" class="pln"><span class="n"><a href="#t35">35</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t36" class="pln"><span class="n"><a href="#t36">36</a></span><span class="t"><span class="str">    time_slot_length : str</span>&nbsp;</span><span class="r"></span></p>
    <p id="t37" class="pln"><span class="n"><a href="#t37">37</a></span><span class="t"><span class="str">        length of the time slot (1h).</span>&nbsp;</span><span class="r"></span></p>
    <p id="t38" class="pln"><span class="n"><a href="#t38">38</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t39" class="pln"><span class="n"><a href="#t39">39</a></span><span class="t"><span class="str">    Examples</span>&nbsp;</span><span class="r"></span></p>
    <p id="t40" class="pln"><span class="n"><a href="#t40">40</a></span><span class="t"><span class="str">    --------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t41" class="pln"><span class="n"><a href="#t41">41</a></span><span class="t"><span class="str">    >>> import skmob</span>&nbsp;</span><span class="r"></span></p>
    <p id="t42" class="pln"><span class="n"><a href="#t42">42</a></span><span class="t"><span class="str">    >>> import pandas as pd</span>&nbsp;</span><span class="r"></span></p>
    <p id="t43" class="pln"><span class="n"><a href="#t43">43</a></span><span class="t"><span class="str">    >>> import geopandas as gpd</span>&nbsp;</span><span class="r"></span></p>
    <p id="t44" class="pln"><span class="n"><a href="#t44">44</a></span><span class="t"><span class="str">    >>> from skmob.models.epr import Ditras</span>&nbsp;</span><span class="r"></span></p>
    <p id="t45" class="pln"><span class="n"><a href="#t45">45</a></span><span class="t"><span class="str">    >>> from skmob.models.markov_diary_generator import MarkovDiaryGenerator</span>&nbsp;</span><span class="r"></span></p>
    <p id="t46" class="pln"><span class="n"><a href="#t46">46</a></span><span class="t"><span class="str">    >>> from skmob.preprocessing import filtering, compression, detection, clustering</span>&nbsp;</span><span class="r"></span></p>
    <p id="t47" class="pln"><span class="n"><a href="#t47">47</a></span><span class="t"><span class="str">    >>> url = skmob.utils.constants.GEOLIFE_SAMPLE</span>&nbsp;</span><span class="r"></span></p>
    <p id="t48" class="pln"><span class="n"><a href="#t48">48</a></span><span class="t"><span class="str">    >>> </span>&nbsp;</span><span class="r"></span></p>
    <p id="t49" class="pln"><span class="n"><a href="#t49">49</a></span><span class="t"><span class="str">    >>> df = pd.read_csv(url, sep=',', compression='gzip')</span>&nbsp;</span><span class="r"></span></p>
    <p id="t50" class="pln"><span class="n"><a href="#t50">50</a></span><span class="t"><span class="str">    >>> tdf = skmob.TrajDataFrame(df, latitude='lat', longitude='lon', user_id='user', datetime='datetime')</span>&nbsp;</span><span class="r"></span></p>
    <p id="t51" class="pln"><span class="n"><a href="#t51">51</a></span><span class="t"><span class="str">    >>> </span>&nbsp;</span><span class="r"></span></p>
    <p id="t52" class="pln"><span class="n"><a href="#t52">52</a></span><span class="t"><span class="str">    >>> ctdf = compression.compress(tdf)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t53" class="pln"><span class="n"><a href="#t53">53</a></span><span class="t"><span class="str">    >>> stdf = detection.stops(ctdf)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t54" class="pln"><span class="n"><a href="#t54">54</a></span><span class="t"><span class="str">    >>> cstdf = clustering.cluster(stdf)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t55" class="pln"><span class="n"><a href="#t55">55</a></span><span class="t"><span class="str">    >>> </span>&nbsp;</span><span class="r"></span></p>
    <p id="t56" class="pln"><span class="n"><a href="#t56">56</a></span><span class="t"><span class="str">    >>> mdg = MarkovDiaryGenerator()</span>&nbsp;</span><span class="r"></span></p>
    <p id="t57" class="pln"><span class="n"><a href="#t57">57</a></span><span class="t"><span class="str">    >>> mdg.fit(cstdf, 2, lid='cluster')</span>&nbsp;</span><span class="r"></span></p>
    <p id="t58" class="pln"><span class="n"><a href="#t58">58</a></span><span class="t"><span class="str">    >>> </span>&nbsp;</span><span class="r"></span></p>
    <p id="t59" class="pln"><span class="n"><a href="#t59">59</a></span><span class="t"><span class="str">    >>> start_time = pd.to_datetime('2019/01/01 08:00:00')</span>&nbsp;</span><span class="r"></span></p>
    <p id="t60" class="pln"><span class="n"><a href="#t60">60</a></span><span class="t"><span class="str">    >>> diary = mdg.generate(100, start_time)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t61" class="pln"><span class="n"><a href="#t61">61</a></span><span class="t"><span class="str">    >>> print(diary)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t62" class="pln"><span class="n"><a href="#t62">62</a></span><span class="t"><span class="str">                 datetime  abstract_location</span>&nbsp;</span><span class="r"></span></p>
    <p id="t63" class="pln"><span class="n"><a href="#t63">63</a></span><span class="t"><span class="str">    0 2019-01-01 08:00:00                  0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t64" class="pln"><span class="n"><a href="#t64">64</a></span><span class="t"><span class="str">    1 2019-01-02 19:00:00                  1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t65" class="pln"><span class="n"><a href="#t65">65</a></span><span class="t"><span class="str">    2 2019-01-02 20:00:00                  0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t66" class="pln"><span class="n"><a href="#t66">66</a></span><span class="t"><span class="str">    3 2019-01-03 17:00:00                  1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t67" class="pln"><span class="n"><a href="#t67">67</a></span><span class="t"><span class="str">    4 2019-01-03 18:00:00                  2</span>&nbsp;</span><span class="r"></span></p>
    <p id="t68" class="pln"><span class="n"><a href="#t68">68</a></span><span class="t"><span class="str">    5 2019-01-04 08:00:00                  0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t69" class="pln"><span class="n"><a href="#t69">69</a></span><span class="t"><span class="str">    6 2019-01-05 03:00:00                  1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t70" class="pln"><span class="n"><a href="#t70">70</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t71" class="pln"><span class="n"><a href="#t71">71</a></span><span class="t"><span class="str">    References</span>&nbsp;</span><span class="r"></span></p>
    <p id="t72" class="pln"><span class="n"><a href="#t72">72</a></span><span class="t"><span class="str">    ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t73" class="pln"><span class="n"><a href="#t73">73</a></span><span class="t"><span class="str">    .. [PS2018] Pappalardo, L. &amp; Simini, F. (2018) Data-driven generation of spatio-temporal routines in human mobility. Data Mining and Knowledge Discovery 32, 787-829, https://link.springer.com/article/10.1007/s10618-017-0548-4</span>&nbsp;</span><span class="r"></span></p>
    <p id="t74" class="pln"><span class="n"><a href="#t74">74</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t75" class="pln"><span class="n"><a href="#t75">75</a></span><span class="t"><span class="str">    See Also</span>&nbsp;</span><span class="r"></span></p>
    <p id="t76" class="pln"><span class="n"><a href="#t76">76</a></span><span class="t"><span class="str">    --------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t77" class="pln"><span class="n"><a href="#t77">77</a></span><span class="t"><span class="str">    Ditras</span>&nbsp;</span><span class="r"></span></p>
    <p id="t78" class="pln"><span class="n"><a href="#t78">78</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t79" class="run"><span class="n"><a href="#t79">79</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">name</span><span class="op">=</span><span class="str">'Markov diary'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t80" class="run"><span class="n"><a href="#t80">80</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p id="t81" class="run"><span class="n"><a href="#t81">81</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_time_slot_length</span> <span class="op">=</span> <span class="str">'1h'</span>&nbsp;</span><span class="r"></span></p>
    <p id="t82" class="run"><span class="n"><a href="#t82">82</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_name</span> <span class="op">=</span> <span class="nam">name</span>&nbsp;</span><span class="r"></span></p>
    <p id="t83" class="pln"><span class="n"><a href="#t83">83</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t84" class="run"><span class="n"><a href="#t84">84</a></span><span class="t">    <span class="op">@</span><span class="nam">property</span>&nbsp;</span><span class="r"></span></p>
    <p id="t85" class="run"><span class="n"><a href="#t85">85</a></span><span class="t">    <span class="key">def</span> <span class="nam">markov_chain_</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t86" class="mis show_mis"><span class="n"><a href="#t86">86</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span>&nbsp;</span><span class="r"></span></p>
    <p id="t87" class="pln"><span class="n"><a href="#t87">87</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t88" class="run"><span class="n"><a href="#t88">88</a></span><span class="t">    <span class="op">@</span><span class="nam">property</span>&nbsp;</span><span class="r"></span></p>
    <p id="t89" class="run"><span class="n"><a href="#t89">89</a></span><span class="t">    <span class="key">def</span> <span class="nam">time_slot_length</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t90" class="mis show_mis"><span class="n"><a href="#t90">90</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_time_slot_length</span>&nbsp;</span><span class="r"></span></p>
    <p id="t91" class="pln"><span class="n"><a href="#t91">91</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t92" class="run"><span class="n"><a href="#t92">92</a></span><span class="t">    <span class="op">@</span><span class="nam">property</span>&nbsp;</span><span class="r"></span></p>
    <p id="t93" class="run"><span class="n"><a href="#t93">93</a></span><span class="t">    <span class="key">def</span> <span class="nam">name</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t94" class="mis show_mis"><span class="n"><a href="#t94">94</a></span><span class="t">        <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_name</span>&nbsp;</span><span class="r"></span></p>
    <p id="t95" class="pln"><span class="n"><a href="#t95">95</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t96" class="run"><span class="n"><a href="#t96">96</a></span><span class="t">    <span class="key">def</span> <span class="nam">_create_empty_markov_chain</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t97" class="pln"><span class="n"><a href="#t97">97</a></span><span class="t">        <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t98" class="pln"><span class="n"><a href="#t98">98</a></span><span class="t"><span class="str">        Create an empty Markov chain, i.e., a matrix 48 * 48 where an element M(i,j) is a pair of pairs</span>&nbsp;</span><span class="r"></span></p>
    <p id="t99" class="pln"><span class="n"><a href="#t99">99</a></span><span class="t"><span class="str">        ((h_i, b_i), (h_j, b_j)), h_i, h_j \in {0, ..., 23} and b_i, b_j \in {0, 1}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t100" class="pln"><span class="n"><a href="#t100">100</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t101" class="run"><span class="n"><a href="#t101">101</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span> <span class="op">=</span> <span class="nam">defaultdict</span><span class="op">(</span><span class="key">lambda</span><span class="op">:</span> <span class="nam">defaultdict</span><span class="op">(</span><span class="nam">float</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t102" class="run"><span class="n"><a href="#t102">102</a></span><span class="t">        <span class="key">for</span> <span class="nam">h1</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="num">0</span><span class="op">,</span> <span class="num">24</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t103" class="run"><span class="n"><a href="#t103">103</a></span><span class="t">            <span class="key">for</span> <span class="nam">r1</span> <span class="key">in</span> <span class="op">[</span><span class="num">0</span><span class="op">,</span> <span class="num">1</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t104" class="run"><span class="n"><a href="#t104">104</a></span><span class="t">                <span class="key">for</span> <span class="nam">h2</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="num">0</span><span class="op">,</span> <span class="num">24</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t105" class="run"><span class="n"><a href="#t105">105</a></span><span class="t">                    <span class="key">for</span> <span class="nam">r2</span> <span class="key">in</span> <span class="op">[</span><span class="num">0</span><span class="op">,</span> <span class="num">1</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t106" class="run"><span class="n"><a href="#t106">106</a></span><span class="t">                        <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="op">(</span><span class="nam">h1</span><span class="op">,</span> <span class="nam">r1</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="op">(</span><span class="nam">h2</span><span class="op">,</span> <span class="nam">r2</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="num">0.0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t107" class="pln"><span class="n"><a href="#t107">107</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t108" class="run"><span class="n"><a href="#t108">108</a></span><span class="t">    <span class="op">@</span><span class="nam">staticmethod</span>&nbsp;</span><span class="r"></span></p>
    <p id="t109" class="run"><span class="n"><a href="#t109">109</a></span><span class="t">    <span class="key">def</span> <span class="nam">_select_loc</span><span class="op">(</span><span class="nam">individual_df</span><span class="op">,</span> <span class="nam">location2frequency</span><span class="op">,</span> <span class="nam">location_column</span><span class="op">=</span><span class="str">'location'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t110" class="pln"><span class="n"><a href="#t110">110</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t111" class="run"><span class="n"><a href="#t111">111</a></span><span class="t">        <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">individual_df</span><span class="op">[</span><span class="nam">location_column</span><span class="op">]</span><span class="op">,</span> <span class="nam">str</span><span class="op">)</span><span class="op">:</span> <span class="com"># if there is at least a location in the time slot</span>&nbsp;</span><span class="r"></span></p>
    <p id="t112" class="run"><span class="n"><a href="#t112">112</a></span><span class="t">            <span class="nam">locations</span> <span class="op">=</span> <span class="nam">individual_df</span><span class="op">[</span><span class="nam">location_column</span><span class="op">]</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">','</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t113" class="pln"><span class="n"><a href="#t113">113</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t114" class="run"><span class="n"><a href="#t114">114</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">locations</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>  <span class="com"># if there just one location, then assign that location to the time slot</span>&nbsp;</span><span class="r"></span></p>
    <p id="t115" class="run"><span class="n"><a href="#t115">115</a></span><span class="t">                <span class="key">return</span> <span class="nam">locations</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t116" class="pln"><span class="n"><a href="#t116">116</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t117" class="mis show_mis"><span class="n"><a href="#t117">117</a></span><span class="t">            <span class="key">elif</span> <span class="nam">len</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">Counter</span><span class="op">(</span><span class="nam">locations</span><span class="op">)</span><span class="op">.</span><span class="nam">values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>  <span class="com"># if there are multiple locations, with the same frequency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t118" class="mis show_mis"><span class="n"><a href="#t118">118</a></span><span class="t">                <span class="key">return</span> <span class="nam">sorted</span><span class="op">(</span><span class="op">{</span><span class="nam">k</span><span class="op">:</span> <span class="nam">location2frequency</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span> <span class="key">for</span> <span class="nam">k</span> <span class="key">in</span> <span class="nam">locations</span><span class="op">}</span><span class="op">.</span><span class="nam">items</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t119" class="pln"><span class="n"><a href="#t119">119</a></span><span class="t">                              <span class="nam">key</span><span class="op">=</span><span class="nam">operator</span><span class="op">.</span><span class="nam">itemgetter</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t120" class="pln"><span class="n"><a href="#t120">120</a></span><span class="t">                              <span class="nam">reverse</span><span class="op">=</span><span class="key">True</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>  <span class="com"># return the locations with the highest overall frequency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t121" class="pln"><span class="n"><a href="#t121">121</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t122" class="pln"><span class="n"><a href="#t122">122</a></span><span class="t">            <span class="key">else</span><span class="op">:</span> <span class="com"># if there multiple location in the same slot, with different frequencies</span>&nbsp;</span><span class="r"></span></p>
    <p id="t123" class="mis show_mis"><span class="n"><a href="#t123">123</a></span><span class="t">                <span class="nam">l</span> <span class="op">=</span> <span class="nam">sorted</span><span class="op">(</span><span class="nam">Counter</span><span class="op">(</span><span class="nam">locations</span><span class="op">)</span><span class="op">.</span><span class="nam">items</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">key</span><span class="op">=</span><span class="nam">operator</span><span class="op">.</span><span class="nam">itemgetter</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">,</span> <span class="nam">reverse</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t124" class="mis show_mis"><span class="n"><a href="#t124">124</a></span><span class="t">                <span class="key">return</span> <span class="nam">l</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t125" class="pln"><span class="n"><a href="#t125">125</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t126" class="pln"><span class="n"><a href="#t126">126</a></span><span class="t">        <span class="com"># if there is no location in the time slot, return NaN</span>&nbsp;</span><span class="r"></span></p>
    <p id="t127" class="run"><span class="n"><a href="#t127">127</a></span><span class="t">        <span class="key">return</span> <span class="nam">np</span><span class="op">.</span><span class="nam">nan</span>&nbsp;</span><span class="r"></span></p>
    <p id="t128" class="pln"><span class="n"><a href="#t128">128</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t129" class="run"><span class="n"><a href="#t129">129</a></span><span class="t">    <span class="op">@</span><span class="nam">staticmethod</span>&nbsp;</span><span class="r"></span></p>
    <p id="t130" class="run"><span class="n"><a href="#t130">130</a></span><span class="t">    <span class="key">def</span> <span class="nam">_get_location2frequency</span><span class="op">(</span><span class="nam">traj</span><span class="op">,</span> <span class="nam">location_column</span><span class="op">=</span><span class="str">'location'</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t131" class="pln"><span class="n"><a href="#t131">131</a></span><span class="t">        <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t132" class="pln"><span class="n"><a href="#t132">132</a></span><span class="t"><span class="str">        Compute the visitation frequency and rank of each location of an individual</span>&nbsp;</span><span class="r"></span></p>
    <p id="t133" class="pln"><span class="n"><a href="#t133">133</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t134" class="pln"><span class="n"><a href="#t134">134</a></span><span class="t"><span class="str">        Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t135" class="pln"><span class="n"><a href="#t135">135</a></span><span class="t"><span class="str">        ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t136" class="pln"><span class="n"><a href="#t136">136</a></span><span class="t"><span class="str">        traj : pandas DataFrame</span>&nbsp;</span><span class="r"></span></p>
    <p id="t137" class="pln"><span class="n"><a href="#t137">137</a></span><span class="t"><span class="str">            the trajectories of the individuals.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t138" class="pln"><span class="n"><a href="#t138">138</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t139" class="pln"><span class="n"><a href="#t139">139</a></span><span class="t"><span class="str">        location_column : str, optional</span>&nbsp;</span><span class="r"></span></p>
    <p id="t140" class="pln"><span class="n"><a href="#t140">140</a></span><span class="t"><span class="str">            the name of the column containing the location identifier. The default is "location".</span>&nbsp;</span><span class="r"></span></p>
    <p id="t141" class="pln"><span class="n"><a href="#t141">141</a></span><span class="t"><span class="str">            </span>&nbsp;</span><span class="r"></span></p>
    <p id="t142" class="pln"><span class="n"><a href="#t142">142</a></span><span class="t"><span class="str">        Returns</span>&nbsp;</span><span class="r"></span></p>
    <p id="t143" class="pln"><span class="n"><a href="#t143">143</a></span><span class="t"><span class="str">        -------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t144" class="pln"><span class="n"><a href="#t144">144</a></span><span class="t"><span class="str">        tuple</span>&nbsp;</span><span class="r"></span></p>
    <p id="t145" class="pln"><span class="n"><a href="#t145">145</a></span><span class="t"><span class="str">            a tuple of two dictionaries of locations to the corresponding visitation frequency and rank, respectively.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t146" class="pln"><span class="n"><a href="#t146">146</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t147" class="run"><span class="n"><a href="#t147">147</a></span><span class="t">        <span class="nam">location2frequency</span><span class="op">,</span> <span class="nam">location2rank</span> <span class="op">=</span> <span class="nam">defaultdict</span><span class="op">(</span><span class="nam">int</span><span class="op">)</span><span class="op">,</span> <span class="nam">defaultdict</span><span class="op">(</span><span class="nam">int</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t148" class="run"><span class="n"><a href="#t148">148</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">row</span> <span class="key">in</span> <span class="nam">traj</span><span class="op">.</span><span class="nam">iterrows</span><span class="op">(</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t149" class="run"><span class="n"><a href="#t149">149</a></span><span class="t">            <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">row</span><span class="op">[</span><span class="nam">location_column</span><span class="op">]</span><span class="op">,</span> <span class="nam">str</span><span class="op">)</span><span class="op">:</span>  <span class="com"># if it is not NaN</span>&nbsp;</span><span class="r"></span></p>
    <p id="t150" class="run"><span class="n"><a href="#t150">150</a></span><span class="t">                <span class="key">for</span> <span class="nam">location</span> <span class="key">in</span> <span class="nam">row</span><span class="op">[</span><span class="nam">location_column</span><span class="op">]</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">','</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t151" class="pln"><span class="n"><a href="#t151">151</a></span><span class="t">                    <span class="com"># we can have more than one location in a time slot</span>&nbsp;</span><span class="r"></span></p>
    <p id="t152" class="pln"><span class="n"><a href="#t152">152</a></span><span class="t">                    <span class="com"># so, every slot has a comma separated list of locations</span>&nbsp;</span><span class="r"></span></p>
    <p id="t153" class="run"><span class="n"><a href="#t153">153</a></span><span class="t">                    <span class="nam">location2frequency</span><span class="op">[</span><span class="nam">location</span><span class="op">]</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t154" class="pln"><span class="n"><a href="#t154">154</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t155" class="pln"><span class="n"><a href="#t155">155</a></span><span class="t">        <span class="com"># compute location2rank</span>&nbsp;</span><span class="r"></span></p>
    <p id="t156" class="run"><span class="n"><a href="#t156">156</a></span><span class="t">        <span class="nam">rank</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t157" class="run"><span class="n"><a href="#t157">157</a></span><span class="t">        <span class="key">for</span> <span class="nam">loc</span> <span class="key">in</span> <span class="nam">sorted</span><span class="op">(</span><span class="nam">location2frequency</span><span class="op">.</span><span class="nam">items</span><span class="op">(</span><span class="op">)</span><span class="op">,</span> <span class="nam">key</span><span class="op">=</span><span class="nam">operator</span><span class="op">.</span><span class="nam">itemgetter</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">,</span> <span class="nam">reverse</span><span class="op">=</span><span class="key">True</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t158" class="run"><span class="n"><a href="#t158">158</a></span><span class="t">            <span class="nam">location</span><span class="op">,</span> <span class="nam">frequency</span> <span class="op">=</span> <span class="nam">loc</span>&nbsp;</span><span class="r"></span></p>
    <p id="t159" class="run"><span class="n"><a href="#t159">159</a></span><span class="t">            <span class="nam">location2rank</span><span class="op">[</span><span class="nam">location</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rank</span>&nbsp;</span><span class="r"></span></p>
    <p id="t160" class="run"><span class="n"><a href="#t160">160</a></span><span class="t">            <span class="nam">rank</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t161" class="run"><span class="n"><a href="#t161">161</a></span><span class="t">        <span class="key">return</span> <span class="nam">location2frequency</span><span class="op">,</span> <span class="nam">location2rank</span>&nbsp;</span><span class="r"></span></p>
    <p id="t162" class="pln"><span class="n"><a href="#t162">162</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t163" class="run"><span class="n"><a href="#t163">163</a></span><span class="t">    <span class="key">def</span> <span class="nam">_create_time_series</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">traj</span><span class="op">,</span> <span class="nam">lid</span><span class="op">=</span><span class="str">'location'</span><span class="op">)</span><span class="op">:</span><span class="com">#start_date, end_date, lid='location'):</span>&nbsp;</span><span class="r"></span></p>
    <p id="t164" class="pln"><span class="n"><a href="#t164">164</a></span><span class="t">        <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t165" class="pln"><span class="n"><a href="#t165">165</a></span><span class="t"><span class="str">        Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t166" class="pln"><span class="n"><a href="#t166">166</a></span><span class="t"><span class="str">        ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t167" class="pln"><span class="n"><a href="#t167">167</a></span><span class="t"><span class="str">        traj : pandas DataFrame</span>&nbsp;</span><span class="r"></span></p>
    <p id="t168" class="pln"><span class="n"><a href="#t168">168</a></span><span class="t"><span class="str">            the trips of an individual.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t169" class="pln"><span class="n"><a href="#t169">169</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t170" class="pln"><span class="n"><a href="#t170">170</a></span><span class="t"><span class="str">        lid : str, optional</span>&nbsp;</span><span class="r"></span></p>
    <p id="t171" class="pln"><span class="n"><a href="#t171">171</a></span><span class="t"><span class="str">            the name of the column containing the location identifier. The default is "location".</span>&nbsp;</span><span class="r"></span></p>
    <p id="t172" class="pln"><span class="n"><a href="#t172">172</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t173" class="pln"><span class="n"><a href="#t173">173</a></span><span class="t"><span class="str">        Returns</span>&nbsp;</span><span class="r"></span></p>
    <p id="t174" class="pln"><span class="n"><a href="#t174">174</a></span><span class="t"><span class="str">        -------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t175" class="pln"><span class="n"><a href="#t175">175</a></span><span class="t"><span class="str">        pandas DataFrame</span>&nbsp;</span><span class="r"></span></p>
    <p id="t176" class="pln"><span class="n"><a href="#t176">176</a></span><span class="t"><span class="str">            the time series of the abstract locations visited by the individual.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t177" class="pln"><span class="n"><a href="#t177">177</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t178" class="pln"><span class="n"><a href="#t178">178</a></span><span class="t">        <span class="com"># lat_lng_df = traj[['lat', 'lng']].drop_duplicates(subset=['lat', 'lng'])</span>&nbsp;</span><span class="r"></span></p>
    <p id="t179" class="pln"><span class="n"><a href="#t179">179</a></span><span class="t">        <span class="com"># lat_lng_df[lid] = np.arange(len(lat_lng_df)).astype('str')</span>&nbsp;</span><span class="r"></span></p>
    <p id="t180" class="pln"><span class="n"><a href="#t180">180</a></span><span class="t">        <span class="com"># traj = pd.merge(traj, lat_lng_df, on=['lat', 'lng'])</span>&nbsp;</span><span class="r"></span></p>
    <p id="t181" class="pln"><span class="n"><a href="#t181">181</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t182" class="run"><span class="n"><a href="#t182">182</a></span><span class="t">        <span class="nam">shift</span> <span class="op">=</span> <span class="nam">traj</span><span class="op">[</span><span class="nam">constants</span><span class="op">.</span><span class="nam">DATETIME</span><span class="op">]</span><span class="op">.</span><span class="nam">min</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">hour</span>&nbsp;</span><span class="r"></span></p>
    <p id="t183" class="run"><span class="n"><a href="#t183">183</a></span><span class="t">        <span class="nam">traj</span> <span class="op">=</span> <span class="nam">traj</span><span class="op">[</span><span class="op">[</span><span class="nam">constants</span><span class="op">.</span><span class="nam">DATETIME</span><span class="op">,</span> <span class="nam">lid</span><span class="op">]</span><span class="op">]</span><span class="op">.</span><span class="nam">set_index</span><span class="op">(</span><span class="nam">date_time</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t184" class="run"><span class="n"><a href="#t184">184</a></span><span class="t">        <span class="nam">traj</span><span class="op">[</span><span class="nam">lid</span><span class="op">]</span> <span class="op">=</span> <span class="nam">traj</span><span class="op">[</span><span class="nam">lid</span><span class="op">]</span><span class="op">.</span><span class="nam">astype</span><span class="op">(</span><span class="str">'str'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t185" class="pln"><span class="n"><a href="#t185">185</a></span><span class="t">        <span class="com"># enlarge (eventually) the time series with the specified freq (replace empty time slots with NaN)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t186" class="run"><span class="n"><a href="#t186">186</a></span><span class="t">        <span class="nam">traj</span> <span class="op">=</span> <span class="nam">traj</span><span class="op">.</span><span class="nam">groupby</span><span class="op">(</span><span class="nam">pd</span><span class="op">.</span><span class="nam">Grouper</span><span class="op">(</span><span class="nam">freq</span><span class="op">=</span><span class="nam">self</span><span class="op">.</span><span class="nam">_time_slot_length</span><span class="op">,</span> <span class="nam">closed</span><span class="op">=</span><span class="str">'left'</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">aggregate</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">x</span><span class="op">:</span> <span class="str">','</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">x</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="str">''</span><span class="op">,</span> <span class="nam">np</span><span class="op">.</span><span class="nam">nan</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t187" class="pln"><span class="n"><a href="#t187">187</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t188" class="pln"><span class="n"><a href="#t188">188</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t189" class="pln"><span class="n"><a href="#t189">189</a></span><span class="t">        <span class="com"># compute the frequency of every location visited by the individual</span>&nbsp;</span><span class="r"></span></p>
    <p id="t190" class="run"><span class="n"><a href="#t190">190</a></span><span class="t">        <span class="nam">location2frequency</span><span class="op">,</span> <span class="nam">location2rank</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_get_location2frequency</span><span class="op">(</span><span class="nam">traj</span><span class="op">,</span> <span class="nam">location_column</span><span class="op">=</span><span class="nam">lid</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t191" class="pln"><span class="n"><a href="#t191">191</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t192" class="pln"><span class="n"><a href="#t192">192</a></span><span class="t">        <span class="com"># select the location for every slot</span>&nbsp;</span><span class="r"></span></p>
    <p id="t193" class="pln"><span class="n"><a href="#t193">193</a></span><span class="t">        <span class="com"># ix = pd.DatetimeIndex(start=start_date, end=end_date, freq=self._time_slot_length)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t194" class="pln"><span class="n"><a href="#t194">194</a></span><span class="t">        <span class="com">#ix = pd.date_range(start=start_date, end=end_date, freq=self._time_slot_length)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t195" class="run"><span class="n"><a href="#t195">195</a></span><span class="t">        <span class="nam">time_series</span> <span class="op">=</span> <span class="nam">traj</span><span class="op">.</span><span class="nam">apply</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">x</span><span class="op">:</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_select_loc</span><span class="op">(</span><span class="nam">x</span><span class="op">,</span> <span class="nam">location2frequency</span><span class="op">,</span> <span class="nam">location_column</span><span class="op">=</span><span class="nam">lid</span><span class="op">)</span><span class="op">,</span> <span class="nam">axis</span><span class="op">=</span><span class="num">1</span><span class="op">)</span><span class="com">#.reindex(ix)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t196" class="pln"><span class="n"><a href="#t196">196</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t197" class="pln"><span class="n"><a href="#t197">197</a></span><span class="t">        <span class="com"># fill the slots with NaN with the previous element or the next element ###</span>&nbsp;</span><span class="r"></span></p>
    <p id="t198" class="run"><span class="n"><a href="#t198">198</a></span><span class="t">        <span class="nam">time_series</span><span class="op">.</span><span class="nam">fillna</span><span class="op">(</span><span class="nam">method</span><span class="op">=</span><span class="str">'ffill'</span><span class="op">,</span> <span class="nam">inplace</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t199" class="run"><span class="n"><a href="#t199">199</a></span><span class="t">        <span class="nam">time_series</span><span class="op">.</span><span class="nam">fillna</span><span class="op">(</span><span class="nam">method</span><span class="op">=</span><span class="str">'bfill'</span><span class="op">,</span> <span class="nam">inplace</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t200" class="pln"><span class="n"><a href="#t200">200</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t201" class="pln"><span class="n"><a href="#t201">201</a></span><span class="t">        <span class="com"># you can use location2frequency to assign a number to every location</span>&nbsp;</span><span class="r"></span></p>
    <p id="t202" class="run"><span class="n"><a href="#t202">202</a></span><span class="t">        <span class="nam">time_series</span> <span class="op">=</span> <span class="nam">time_series</span><span class="op">.</span><span class="nam">apply</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">x</span><span class="op">:</span> <span class="nam">location2rank</span><span class="op">[</span><span class="nam">x</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t203" class="run"><span class="n"><a href="#t203">203</a></span><span class="t">        <span class="key">return</span> <span class="nam">time_series</span><span class="op">,</span> <span class="nam">shift</span>&nbsp;</span><span class="r"></span></p>
    <p id="t204" class="pln"><span class="n"><a href="#t204">204</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t205" class="run"><span class="n"><a href="#t205">205</a></span><span class="t">    <span class="key">def</span> <span class="nam">_update_markov_chain</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">time_series</span><span class="op">,</span> <span class="nam">shift</span><span class="op">=</span><span class="num">0</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t206" class="pln"><span class="n"><a href="#t206">206</a></span><span class="t">        <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t207" class="pln"><span class="n"><a href="#t207">207</a></span><span class="t"><span class="str">        Update the Markov Chain by including the behavior of an individual</span>&nbsp;</span><span class="r"></span></p>
    <p id="t208" class="pln"><span class="n"><a href="#t208">208</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t209" class="pln"><span class="n"><a href="#t209">209</a></span><span class="t"><span class="str">        Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t210" class="pln"><span class="n"><a href="#t210">210</a></span><span class="t"><span class="str">        ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t211" class="pln"><span class="n"><a href="#t211">211</a></span><span class="t"><span class="str">        time_series: pandas DataFrame</span>&nbsp;</span><span class="r"></span></p>
    <p id="t212" class="pln"><span class="n"><a href="#t212">212</a></span><span class="t"><span class="str">            time series of abstract locations visisted by an individual.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t213" class="pln"><span class="n"><a href="#t213">213</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t214" class="run"><span class="n"><a href="#t214">214</a></span><span class="t">        <span class="nam">HOME</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t215" class="run"><span class="n"><a href="#t215">215</a></span><span class="t">        <span class="nam">TYPICAL</span><span class="op">,</span> <span class="nam">NON_TYPICAL</span> <span class="op">=</span> <span class="num">1</span><span class="op">,</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t216" class="pln"><span class="n"><a href="#t216">216</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t217" class="run"><span class="n"><a href="#t217">217</a></span><span class="t">        <span class="nam">n</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">time_series</span><span class="op">)</span>  <span class="com"># n is the length of the time series of the individual</span>&nbsp;</span><span class="r"></span></p>
    <p id="t218" class="run"><span class="n"><a href="#t218">218</a></span><span class="t">        <span class="nam">slot</span> <span class="op">=</span> <span class="num">0</span>  <span class="com"># it starts from the first slot in the time series</span>&nbsp;</span><span class="r"></span></p>
    <p id="t219" class="pln"><span class="n"><a href="#t219">219</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t220" class="run"><span class="n"><a href="#t220">220</a></span><span class="t">        <span class="key">while</span> <span class="nam">slot</span> <span class="op">&lt;</span> <span class="nam">n</span> <span class="op">-</span> <span class="num">1</span><span class="op">:</span>  <span class="com"># scan the time series of the individual, time slot by time slot</span>&nbsp;</span><span class="r"></span></p>
    <p id="t221" class="pln"><span class="n"><a href="#t221">221</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t222" class="pln"><span class="n"><a href="#t222">222</a></span><span class="t">            <span class="com">#h = (slot % 24)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t223" class="run"><span class="n"><a href="#t223">223</a></span><span class="t">            <span class="nam">h</span> <span class="op">=</span> <span class="op">(</span><span class="nam">slot</span>  <span class="op">+</span> <span class="nam">shift</span><span class="op">)</span> <span class="op">%</span> <span class="num">24</span>  <span class="com"># h, the hour of the day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t224" class="run"><span class="n"><a href="#t224">224</a></span><span class="t">            <span class="nam">next_h</span> <span class="op">=</span> <span class="op">(</span><span class="nam">h</span> <span class="op">+</span> <span class="num">1</span><span class="op">)</span> <span class="op">%</span> <span class="num">24</span>  <span class="com"># next_h, the next hour of the day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t225" class="pln"><span class="n"><a href="#t225">225</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t226" class="run"><span class="n"><a href="#t226">226</a></span><span class="t">            <span class="nam">loc_h</span> <span class="op">=</span> <span class="nam">time_series</span><span class="op">[</span><span class="nam">slot</span><span class="op">]</span>  <span class="com"># loc_h  ,   abstract location at the current slot</span>&nbsp;</span><span class="r"></span></p>
    <p id="t227" class="run"><span class="n"><a href="#t227">227</a></span><span class="t">            <span class="nam">next_loc_h</span> <span class="op">=</span> <span class="nam">time_series</span><span class="op">[</span><span class="nam">slot</span> <span class="op">+</span> <span class="num">1</span><span class="op">]</span>  <span class="com"># d_{h+1},   abstract location at the next slot</span>&nbsp;</span><span class="r"></span></p>
    <p id="t228" class="pln"><span class="n"><a href="#t228">228</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t229" class="run"><span class="n"><a href="#t229">229</a></span><span class="t">            <span class="key">if</span> <span class="nam">loc_h</span> <span class="op">==</span> <span class="nam">HOME</span><span class="op">:</span>  <span class="com"># if \delta(loc_h, t_h) == 1, i.e., she stays at home</span>&nbsp;</span><span class="r"></span></p>
    <p id="t230" class="pln"><span class="n"><a href="#t230">230</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t231" class="pln"><span class="n"><a href="#t231">231</a></span><span class="t">                <span class="com"># we have two cases</span>&nbsp;</span><span class="r"></span></p>
    <p id="t232" class="run"><span class="n"><a href="#t232">232</a></span><span class="t">                <span class="key">if</span> <span class="nam">next_loc_h</span> <span class="op">==</span> <span class="nam">HOME</span><span class="op">:</span>  <span class="com"># if \delta(d_{h + 1}, t_{h + 1}) == 1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t233" class="pln"><span class="n"><a href="#t233">233</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t234" class="pln"><span class="n"><a href="#t234">234</a></span><span class="t">                    <span class="com"># we are in Type1: (h, 1) --> (h + 1, 1)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t235" class="run"><span class="n"><a href="#t235">235</a></span><span class="t">                    <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="op">(</span><span class="nam">h</span><span class="op">,</span> <span class="nam">TYPICAL</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="op">(</span><span class="nam">next_h</span><span class="op">,</span> <span class="nam">TYPICAL</span><span class="op">)</span><span class="op">]</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t236" class="pln"><span class="n"><a href="#t236">236</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t237" class="pln"><span class="n"><a href="#t237">237</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>  <span class="com"># she will be not in the typical location</span>&nbsp;</span><span class="r"></span></p>
    <p id="t238" class="pln"><span class="n"><a href="#t238">238</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t239" class="pln"><span class="n"><a href="#t239">239</a></span><span class="t">                    <span class="com"># we are in Type2: (h, 1) --> (h + tau, 0)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t240" class="run"><span class="n"><a href="#t240">240</a></span><span class="t">                    <span class="nam">tau</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t241" class="run"><span class="n"><a href="#t241">241</a></span><span class="t">                    <span class="key">if</span> <span class="nam">slot</span> <span class="op">+</span> <span class="num">2</span> <span class="op">&lt;</span> <span class="nam">n</span><span class="op">:</span>  <span class="com"># if slot is the second last in the time series</span>&nbsp;</span><span class="r"></span></p>
    <p id="t242" class="pln"><span class="n"><a href="#t242">242</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t243" class="run"><span class="n"><a href="#t243">243</a></span><span class="t">                        <span class="key">for</span> <span class="nam">j</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">slot</span> <span class="op">+</span> <span class="num">2</span><span class="op">,</span> <span class="nam">n</span><span class="op">)</span><span class="op">:</span>  <span class="com"># in slot + 1 we do not have HOME so we start from slot + 2</span>&nbsp;</span><span class="r"></span></p>
    <p id="t244" class="run"><span class="n"><a href="#t244">244</a></span><span class="t">                            <span class="nam">loc_hh</span> <span class="op">=</span> <span class="nam">time_series</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t245" class="run"><span class="n"><a href="#t245">245</a></span><span class="t">                            <span class="key">if</span> <span class="nam">loc_hh</span> <span class="op">==</span> <span class="nam">next_loc_h</span><span class="op">:</span>  <span class="com"># if \delta(d_{h + j}, d_{h + 1}) == 1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t246" class="run"><span class="n"><a href="#t246">246</a></span><span class="t">                                <span class="nam">tau</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t247" class="pln"><span class="n"><a href="#t247">247</a></span><span class="t">                            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t248" class="run"><span class="n"><a href="#t248">248</a></span><span class="t">                                <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p id="t249" class="pln"><span class="n"><a href="#t249">249</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t250" class="run"><span class="n"><a href="#t250">250</a></span><span class="t">                        <span class="nam">h_tau</span> <span class="op">=</span> <span class="op">(</span><span class="nam">h</span> <span class="op">+</span> <span class="nam">tau</span><span class="op">)</span> <span class="op">%</span> <span class="num">24</span>&nbsp;</span><span class="r"></span></p>
    <p id="t251" class="pln"><span class="n"><a href="#t251">251</a></span><span class="t">                        <span class="com"># update the state of edge (h, 1) --> (h + tau, 0)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t252" class="run"><span class="n"><a href="#t252">252</a></span><span class="t">                        <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="op">(</span><span class="nam">h</span><span class="op">,</span> <span class="nam">TYPICAL</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="op">(</span><span class="nam">h_tau</span><span class="op">,</span> <span class="nam">NON_TYPICAL</span><span class="op">)</span><span class="op">]</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t253" class="run"><span class="n"><a href="#t253">253</a></span><span class="t">                        <span class="nam">slot</span> <span class="op">=</span> <span class="nam">j</span> <span class="op">-</span> <span class="num">2</span> <span class="com">#1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t254" class="pln"><span class="n"><a href="#t254">254</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t255" class="pln"><span class="n"><a href="#t255">255</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>  <span class="com"># terminate the while cycle</span>&nbsp;</span><span class="r"></span></p>
    <p id="t256" class="run"><span class="n"><a href="#t256">256</a></span><span class="t">                        <span class="nam">slot</span> <span class="op">=</span> <span class="nam">n</span>&nbsp;</span><span class="r"></span></p>
    <p id="t257" class="pln"><span class="n"><a href="#t257">257</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t258" class="pln"><span class="n"><a href="#t258">258</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>  <span class="com"># loc_h != HOME</span>&nbsp;</span><span class="r"></span></p>
    <p id="t259" class="pln"><span class="n"><a href="#t259">259</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t260" class="run"><span class="n"><a href="#t260">260</a></span><span class="t">                <span class="key">if</span> <span class="nam">next_loc_h</span> <span class="op">==</span> <span class="nam">HOME</span><span class="op">:</span>  <span class="com"># if \delta(d_{h + 1}, t_{h + 1}) == 1, i.e., she will stay at home</span>&nbsp;</span><span class="r"></span></p>
    <p id="t261" class="pln"><span class="n"><a href="#t261">261</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t262" class="pln"><span class="n"><a href="#t262">262</a></span><span class="t">                    <span class="com"># we are in Type3: (h, 0) --> (h + 1, 1)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t263" class="run"><span class="n"><a href="#t263">263</a></span><span class="t">                    <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="op">(</span><span class="nam">h</span><span class="op">,</span> <span class="nam">NON_TYPICAL</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="op">(</span><span class="nam">next_h</span><span class="op">,</span> <span class="nam">TYPICAL</span><span class="op">)</span><span class="op">]</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t264" class="pln"><span class="n"><a href="#t264">264</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t265" class="pln"><span class="n"><a href="#t265">265</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t266" class="pln"><span class="n"><a href="#t266">266</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t267" class="pln"><span class="n"><a href="#t267">267</a></span><span class="t">                    <span class="com"># we are in Type 4: (h, 0) --> (h + tau, 0)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t268" class="run"><span class="n"><a href="#t268">268</a></span><span class="t">                    <span class="nam">tau</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t269" class="run"><span class="n"><a href="#t269">269</a></span><span class="t">                    <span class="key">if</span> <span class="nam">slot</span> <span class="op">+</span> <span class="num">2</span> <span class="op">&lt;</span> <span class="nam">n</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t270" class="pln"><span class="n"><a href="#t270">270</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t271" class="run"><span class="n"><a href="#t271">271</a></span><span class="t">                        <span class="key">for</span> <span class="nam">j</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">slot</span> <span class="op">+</span> <span class="num">2</span><span class="op">,</span> <span class="nam">n</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t272" class="run"><span class="n"><a href="#t272">272</a></span><span class="t">                            <span class="nam">loc_hh</span> <span class="op">=</span> <span class="nam">time_series</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t273" class="run"><span class="n"><a href="#t273">273</a></span><span class="t">                            <span class="key">if</span> <span class="nam">loc_hh</span> <span class="op">==</span> <span class="nam">next_loc_h</span><span class="op">:</span>  <span class="com"># if \delta(d_{h + j}, d_{h + 1}) == 1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t274" class="run"><span class="n"><a href="#t274">274</a></span><span class="t">                                <span class="nam">tau</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t275" class="pln"><span class="n"><a href="#t275">275</a></span><span class="t">                            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t276" class="run"><span class="n"><a href="#t276">276</a></span><span class="t">                                <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p id="t277" class="pln"><span class="n"><a href="#t277">277</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t278" class="run"><span class="n"><a href="#t278">278</a></span><span class="t">                        <span class="nam">h_tau</span> <span class="op">=</span> <span class="op">(</span><span class="nam">h</span> <span class="op">+</span> <span class="nam">tau</span><span class="op">)</span> <span class="op">%</span> <span class="num">24</span>&nbsp;</span><span class="r"></span></p>
    <p id="t279" class="pln"><span class="n"><a href="#t279">279</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t280" class="pln"><span class="n"><a href="#t280">280</a></span><span class="t">                        <span class="com"># update the state of edge (h, 0) --> (h + tau, 0)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t281" class="run"><span class="n"><a href="#t281">281</a></span><span class="t">                        <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="op">(</span><span class="nam">h</span><span class="op">,</span> <span class="nam">NON_TYPICAL</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="op">(</span><span class="nam">h_tau</span><span class="op">,</span> <span class="nam">NON_TYPICAL</span><span class="op">)</span><span class="op">]</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t282" class="run"><span class="n"><a href="#t282">282</a></span><span class="t">                        <span class="nam">slot</span> <span class="op">=</span> <span class="nam">j</span> <span class="op">-</span> <span class="num">2</span> <span class="com">#1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t283" class="pln"><span class="n"><a href="#t283">283</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t284" class="pln"><span class="n"><a href="#t284">284</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t285" class="run"><span class="n"><a href="#t285">285</a></span><span class="t">                        <span class="nam">slot</span> <span class="op">=</span> <span class="nam">n</span>&nbsp;</span><span class="r"></span></p>
    <p id="t286" class="pln"><span class="n"><a href="#t286">286</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t287" class="run"><span class="n"><a href="#t287">287</a></span><span class="t">            <span class="nam">slot</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t288" class="pln"><span class="n"><a href="#t288">288</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t289" class="run"><span class="n"><a href="#t289">289</a></span><span class="t">    <span class="key">def</span> <span class="nam">_normalize_markov_chain</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t290" class="pln"><span class="n"><a href="#t290">290</a></span><span class="t">        <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t291" class="pln"><span class="n"><a href="#t291">291</a></span><span class="t"><span class="str">        Transform the dictionary into a proper Markov chain, i.e., normalize by row in order</span>&nbsp;</span><span class="r"></span></p>
    <p id="t292" class="pln"><span class="n"><a href="#t292">292</a></span><span class="t"><span class="str">        to obtain transition probabilities.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t293" class="pln"><span class="n"><a href="#t293">293</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t294" class="pln"><span class="n"><a href="#t294">294</a></span><span class="t">        <span class="com"># compute the probabilities of the Markov chain, i.e. normalize by row</span>&nbsp;</span><span class="r"></span></p>
    <p id="t295" class="run"><span class="n"><a href="#t295">295</a></span><span class="t">        <span class="key">for</span> <span class="nam">state1</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t296" class="run"><span class="n"><a href="#t296">296</a></span><span class="t">            <span class="nam">tot</span> <span class="op">=</span> <span class="nam">sum</span><span class="op">(</span><span class="op">[</span><span class="nam">prob</span> <span class="key">for</span> <span class="nam">prob</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="nam">state1</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t297" class="run"><span class="n"><a href="#t297">297</a></span><span class="t">            <span class="key">for</span> <span class="nam">state2</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="nam">state1</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t298" class="run"><span class="n"><a href="#t298">298</a></span><span class="t">                <span class="key">if</span> <span class="nam">tot</span> <span class="op">!=</span> <span class="num">0.0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t299" class="run"><span class="n"><a href="#t299">299</a></span><span class="t">                    <span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="nam">state1</span><span class="op">]</span><span class="op">[</span><span class="nam">state2</span><span class="op">]</span> <span class="op">/=</span> <span class="nam">tot</span>&nbsp;</span><span class="r"></span></p>
    <p id="t300" class="pln"><span class="n"><a href="#t300">300</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t301" class="run"><span class="n"><a href="#t301">301</a></span><span class="t">    <span class="key">def</span> <span class="nam">fit</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">traj</span><span class="op">,</span> <span class="nam">n_individuals</span><span class="op">,</span> <span class="nam">lid</span><span class="op">=</span><span class="str">'location'</span><span class="op">)</span><span class="op">:</span> <span class="com">#start_date, end_date</span>&nbsp;</span><span class="r"></span></p>
    <p id="t302" class="pln"><span class="n"><a href="#t302">302</a></span><span class="t">        <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t303" class="pln"><span class="n"><a href="#t303">303</a></span><span class="t"><span class="str">        Train the markov mobility diary from real trajectories.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t304" class="pln"><span class="n"><a href="#t304">304</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t305" class="pln"><span class="n"><a href="#t305">305</a></span><span class="t"><span class="str">        Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t306" class="pln"><span class="n"><a href="#t306">306</a></span><span class="t"><span class="str">        ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t307" class="pln"><span class="n"><a href="#t307">307</a></span><span class="t"><span class="str">        traj : TrajDataFrame</span>&nbsp;</span><span class="r"></span></p>
    <p id="t308" class="pln"><span class="n"><a href="#t308">308</a></span><span class="t"><span class="str">            the trajectories of the individuals.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t309" class="pln"><span class="n"><a href="#t309">309</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t310" class="pln"><span class="n"><a href="#t310">310</a></span><span class="t"><span class="str">        n_individuals : int</span>&nbsp;</span><span class="r"></span></p>
    <p id="t311" class="pln"><span class="n"><a href="#t311">311</a></span><span class="t"><span class="str">            the number of individuals in the TrajDataFrame to consider.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t312" class="pln"><span class="n"><a href="#t312">312</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t313" class="pln"><span class="n"><a href="#t313">313</a></span><span class="t"><span class="str">        lid : string, optional</span>&nbsp;</span><span class="r"></span></p>
    <p id="t314" class="pln"><span class="n"><a href="#t314">314</a></span><span class="t"><span class="str">            the name of the column containing the identifier of the location. The default is "location".</span>&nbsp;</span><span class="r"></span></p>
    <p id="t315" class="pln"><span class="n"><a href="#t315">315</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t316" class="pln"><span class="n"><a href="#t316">316</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t317" class="run"><span class="n"><a href="#t317">317</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_create_empty_markov_chain</span><span class="op">(</span><span class="op">)</span>  <span class="com"># initialize the markov chain</span>&nbsp;</span><span class="r"></span></p>
    <p id="t318" class="pln"><span class="n"><a href="#t318">318</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t319" class="run"><span class="n"><a href="#t319">319</a></span><span class="t">        <span class="nam">individuals</span> <span class="op">=</span> <span class="nam">traj</span><span class="op">.</span><span class="nam">uid</span><span class="op">.</span><span class="nam">unique</span><span class="op">(</span><span class="op">)</span>  <span class="com"># list of individuals' identifiers</span>&nbsp;</span><span class="r"></span></p>
    <p id="t320" class="run"><span class="n"><a href="#t320">320</a></span><span class="t">        <span class="key">with</span> <span class="nam">tqdm</span><span class="op">(</span><span class="nam">total</span><span class="op">=</span><span class="nam">n_individuals</span><span class="op">)</span> <span class="key">as</span> <span class="nam">pbar</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t321" class="pln"><span class="n"><a href="#t321">321</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t322" class="run"><span class="n"><a href="#t322">322</a></span><span class="t">            <span class="key">for</span> <span class="nam">individual</span> <span class="key">in</span> <span class="nam">individuals</span><span class="op">[</span><span class="op">:</span><span class="nam">n_individuals</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t323" class="pln"><span class="n"><a href="#t323">323</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t324" class="pln"><span class="n"><a href="#t324">324</a></span><span class="t">                <span class="com"># create the time series of the individual</span>&nbsp;</span><span class="r"></span></p>
    <p id="t325" class="run"><span class="n"><a href="#t325">325</a></span><span class="t">                <span class="nam">time_series</span><span class="op">,</span> <span class="nam">shift</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_create_time_series</span><span class="op">(</span><span class="nam">traj</span><span class="op">[</span><span class="nam">traj</span><span class="op">.</span><span class="nam">uid</span> <span class="op">==</span> <span class="nam">individual</span><span class="op">]</span><span class="op">,</span> <span class="nam">lid</span><span class="op">=</span><span class="nam">lid</span><span class="op">)</span> <span class="com"># start_date, end_date,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t326" class="pln"><span class="n"><a href="#t326">326</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t327" class="pln"><span class="n"><a href="#t327">327</a></span><span class="t">                <span class="com"># update the markov chain according to the individual's time series</span>&nbsp;</span><span class="r"></span></p>
    <p id="t328" class="run"><span class="n"><a href="#t328">328</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">_update_markov_chain</span><span class="op">(</span><span class="nam">time_series</span><span class="op">,</span> <span class="nam">shift</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t329" class="pln"><span class="n"><a href="#t329">329</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t330" class="run"><span class="n"><a href="#t330">330</a></span><span class="t">                <span class="nam">pbar</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t331" class="pln"><span class="n"><a href="#t331">331</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t332" class="pln"><span class="n"><a href="#t332">332</a></span><span class="t">        <span class="com"># normalize the markov chain, i.e., normalize the transitions by row</span>&nbsp;</span><span class="r"></span></p>
    <p id="t333" class="run"><span class="n"><a href="#t333">333</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">_normalize_markov_chain</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t334" class="pln"><span class="n"><a href="#t334">334</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t335" class="run"><span class="n"><a href="#t335">335</a></span><span class="t">    <span class="op">@</span><span class="nam">staticmethod</span>&nbsp;</span><span class="r"></span></p>
    <p id="t336" class="run"><span class="n"><a href="#t336">336</a></span><span class="t">    <span class="key">def</span> <span class="nam">_weighted_random_selection</span><span class="op">(</span><span class="nam">weights</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t337" class="pln"><span class="n"><a href="#t337">337</a></span><span class="t">        <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t338" class="pln"><span class="n"><a href="#t338">338</a></span><span class="t"><span class="str">        Choose an index from the list of weights according to the numbers in the list</span>&nbsp;</span><span class="r"></span></p>
    <p id="t339" class="pln"><span class="n"><a href="#t339">339</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t340" class="pln"><span class="n"><a href="#t340">340</a></span><span class="t"><span class="str">        Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t341" class="pln"><span class="n"><a href="#t341">341</a></span><span class="t"><span class="str">        ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t342" class="pln"><span class="n"><a href="#t342">342</a></span><span class="t"><span class="str">        weights: list</span>&nbsp;</span><span class="r"></span></p>
    <p id="t343" class="pln"><span class="n"><a href="#t343">343</a></span><span class="t"><span class="str">            a list of weights (e.g., probabilities)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t344" class="pln"><span class="n"><a href="#t344">344</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t345" class="pln"><span class="n"><a href="#t345">345</a></span><span class="t"><span class="str">        Returns</span>&nbsp;</span><span class="r"></span></p>
    <p id="t346" class="pln"><span class="n"><a href="#t346">346</a></span><span class="t"><span class="str">        -------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t347" class="pln"><span class="n"><a href="#t347">347</a></span><span class="t"><span class="str">        index: int</span>&nbsp;</span><span class="r"></span></p>
    <p id="t348" class="pln"><span class="n"><a href="#t348">348</a></span><span class="t"><span class="str">            the index of element chosen from the list</span>&nbsp;</span><span class="r"></span></p>
    <p id="t349" class="pln"><span class="n"><a href="#t349">349</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t350" class="pln"><span class="n"><a href="#t350">350</a></span><span class="t">        <span class="com"># totals = []</span>&nbsp;</span><span class="r"></span></p>
    <p id="t351" class="pln"><span class="n"><a href="#t351">351</a></span><span class="t">        <span class="com"># running_total = 0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t352" class="pln"><span class="n"><a href="#t352">352</a></span><span class="t">        <span class="com">#</span>&nbsp;</span><span class="r"></span></p>
    <p id="t353" class="pln"><span class="n"><a href="#t353">353</a></span><span class="t">        <span class="com"># for w in weights:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t354" class="pln"><span class="n"><a href="#t354">354</a></span><span class="t">        <span class="com">#     running_total += w</span>&nbsp;</span><span class="r"></span></p>
    <p id="t355" class="pln"><span class="n"><a href="#t355">355</a></span><span class="t">        <span class="com">#     totals.append(running_total)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t356" class="pln"><span class="n"><a href="#t356">356</a></span><span class="t">        <span class="com">#</span>&nbsp;</span><span class="r"></span></p>
    <p id="t357" class="pln"><span class="n"><a href="#t357">357</a></span><span class="t">        <span class="com"># rnd = random.random() * running_total</span>&nbsp;</span><span class="r"></span></p>
    <p id="t358" class="pln"><span class="n"><a href="#t358">358</a></span><span class="t">        <span class="com"># for index, total in enumerate(totals):</span>&nbsp;</span><span class="r"></span></p>
    <p id="t359" class="pln"><span class="n"><a href="#t359">359</a></span><span class="t">        <span class="com">#     if rnd &lt; total:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t360" class="pln"><span class="n"><a href="#t360">360</a></span><span class="t">        <span class="com">#         return index</span>&nbsp;</span><span class="r"></span></p>
    <p id="t361" class="pln"><span class="n"><a href="#t361">361</a></span><span class="t">        <span class="com"># return len(totals) - 1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t362" class="run"><span class="n"><a href="#t362">362</a></span><span class="t">        <span class="key">return</span> <span class="nam">np</span><span class="op">.</span><span class="nam">searchsorted</span><span class="op">(</span><span class="nam">np</span><span class="op">.</span><span class="nam">cumsum</span><span class="op">(</span><span class="nam">weights</span><span class="op">)</span><span class="op">,</span> <span class="nam">random</span><span class="op">.</span><span class="nam">random</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t363" class="pln"><span class="n"><a href="#t363">363</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t364" class="pln"><span class="n"><a href="#t364">364</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t365" class="run"><span class="n"><a href="#t365">365</a></span><span class="t">    <span class="key">def</span> <span class="nam">generate</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">diary_length</span><span class="op">,</span> <span class="nam">start_date</span><span class="op">,</span> <span class="nam">random_state</span><span class="op">=</span><span class="key">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t366" class="pln"><span class="n"><a href="#t366">366</a></span><span class="t">        <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t367" class="pln"><span class="n"><a href="#t367">367</a></span><span class="t"><span class="str">        Start the generation of the mobility diary.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t368" class="pln"><span class="n"><a href="#t368">368</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t369" class="pln"><span class="n"><a href="#t369">369</a></span><span class="t"><span class="str">        Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t370" class="pln"><span class="n"><a href="#t370">370</a></span><span class="t"><span class="str">        ----------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t371" class="pln"><span class="n"><a href="#t371">371</a></span><span class="t"><span class="str">        diary_length : int</span>&nbsp;</span><span class="r"></span></p>
    <p id="t372" class="pln"><span class="n"><a href="#t372">372</a></span><span class="t"><span class="str">            the length of the diary in hours.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t373" class="pln"><span class="n"><a href="#t373">373</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t374" class="pln"><span class="n"><a href="#t374">374</a></span><span class="t"><span class="str">        start_date : datetime</span>&nbsp;</span><span class="r"></span></p>
    <p id="t375" class="pln"><span class="n"><a href="#t375">375</a></span><span class="t"><span class="str">            the starting date of the generation.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t376" class="pln"><span class="n"><a href="#t376">376</a></span><span class="t"><span class="str">        </span>&nbsp;</span><span class="r"></span></p>
    <p id="t377" class="pln"><span class="n"><a href="#t377">377</a></span><span class="t"><span class="str">        Returns</span>&nbsp;</span><span class="r"></span></p>
    <p id="t378" class="pln"><span class="n"><a href="#t378">378</a></span><span class="t"><span class="str">        -------</span>&nbsp;</span><span class="r"></span></p>
    <p id="t379" class="pln"><span class="n"><a href="#t379">379</a></span><span class="t"><span class="str">        pandas DataFrame</span>&nbsp;</span><span class="r"></span></p>
    <p id="t380" class="pln"><span class="n"><a href="#t380">380</a></span><span class="t"><span class="str">            the generated mobility diary.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t381" class="pln"><span class="n"><a href="#t381">381</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t382" class="run"><span class="n"><a href="#t382">382</a></span><span class="t">        <span class="nam">current_date</span> <span class="op">=</span> <span class="nam">start_date</span>&nbsp;</span><span class="r"></span></p>
    <p id="t383" class="run"><span class="n"><a href="#t383">383</a></span><span class="t">        <span class="nam">V</span><span class="op">,</span> <span class="nam">i</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span><span class="op">,</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t384" class="run"><span class="n"><a href="#t384">384</a></span><span class="t">        <span class="nam">prev_state</span> <span class="op">=</span> <span class="op">(</span><span class="nam">i</span><span class="op">,</span> <span class="num">1</span><span class="op">)</span>  <span class="com"># it starts from the typical location at midnight</span>&nbsp;</span><span class="r"></span></p>
    <p id="t385" class="run"><span class="n"><a href="#t385">385</a></span><span class="t">        <span class="nam">V</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">prev_state</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t386" class="pln"><span class="n"><a href="#t386">386</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t387" class="run"><span class="n"><a href="#t387">387</a></span><span class="t">        <span class="key">if</span> <span class="nam">random_state</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t388" class="run"><span class="n"><a href="#t388">388</a></span><span class="t">            <span class="nam">random</span><span class="op">.</span><span class="nam">seed</span><span class="op">(</span><span class="nam">random_state</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t389" class="pln"><span class="n"><a href="#t389">389</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t390" class="run"><span class="n"><a href="#t390">390</a></span><span class="t">        <span class="key">while</span> <span class="nam">i</span> <span class="op">&lt;</span> <span class="nam">diary_length</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t391" class="pln"><span class="n"><a href="#t391">391</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t392" class="run"><span class="n"><a href="#t392">392</a></span><span class="t">            <span class="nam">h</span> <span class="op">=</span> <span class="nam">i</span> <span class="op">%</span> <span class="num">24</span>  <span class="com"># the hour of the day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t393" class="pln"><span class="n"><a href="#t393">393</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t394" class="pln"><span class="n"><a href="#t394">394</a></span><span class="t">            <span class="com"># select the next state in the Markov chain</span>&nbsp;</span><span class="r"></span></p>
    <p id="t395" class="run"><span class="n"><a href="#t395">395</a></span><span class="t">            <span class="nam">p</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="nam">prev_state</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t396" class="run"><span class="n"><a href="#t396">396</a></span><span class="t">            <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">p</span><span class="op">)</span> <span class="op">==</span> <span class="num">0.</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t397" class="run"><span class="n"><a href="#t397">397</a></span><span class="t">                <span class="nam">hh</span><span class="op">,</span> <span class="nam">rr</span> <span class="op">=</span> <span class="nam">prev_state</span>&nbsp;</span><span class="r"></span></p>
    <p id="t398" class="run"><span class="n"><a href="#t398">398</a></span><span class="t">                <span class="nam">next_state</span> <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="nam">hh</span> <span class="op">+</span> <span class="num">1</span><span class="op">)</span> <span class="op">%</span> <span class="num">24</span><span class="op">,</span> <span class="nam">rr</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t399" class="pln"><span class="n"><a href="#t399">399</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t400" class="run"><span class="n"><a href="#t400">400</a></span><span class="t">                <span class="nam">index</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">_weighted_random_selection</span><span class="op">(</span><span class="nam">p</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t401" class="run"><span class="n"><a href="#t401">401</a></span><span class="t">                <span class="nam">next_state</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">_markov_chain_</span><span class="op">[</span><span class="nam">prev_state</span><span class="op">]</span><span class="op">.</span><span class="nam">keys</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="nam">index</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t402" class="run"><span class="n"><a href="#t402">402</a></span><span class="t">            <span class="nam">V</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">next_state</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t403" class="pln"><span class="n"><a href="#t403">403</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t404" class="run"><span class="n"><a href="#t404">404</a></span><span class="t">            <span class="nam">j</span> <span class="op">=</span> <span class="nam">next_state</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t405" class="run"><span class="n"><a href="#t405">405</a></span><span class="t">            <span class="key">if</span> <span class="nam">j</span> <span class="op">></span> <span class="nam">h</span><span class="op">:</span>  <span class="com"># we are in the same day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t406" class="run"><span class="n"><a href="#t406">406</a></span><span class="t">                <span class="nam">i</span> <span class="op">+=</span> <span class="nam">j</span> <span class="op">-</span> <span class="nam">h</span>&nbsp;</span><span class="r"></span></p>
    <p id="t407" class="pln"><span class="n"><a href="#t407">407</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>  <span class="com"># we are in the next day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t408" class="run"><span class="n"><a href="#t408">408</a></span><span class="t">                <span class="nam">i</span> <span class="op">+=</span> <span class="num">24</span> <span class="op">-</span> <span class="nam">h</span> <span class="op">+</span> <span class="nam">j</span>&nbsp;</span><span class="r"></span></p>
    <p id="t409" class="pln"><span class="n"><a href="#t409">409</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t410" class="run"><span class="n"><a href="#t410">410</a></span><span class="t">            <span class="nam">prev_state</span> <span class="op">=</span> <span class="nam">next_state</span>&nbsp;</span><span class="r"></span></p>
    <p id="t411" class="pln"><span class="n"><a href="#t411">411</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t412" class="pln"><span class="n"><a href="#t412">412</a></span><span class="t">        <span class="com"># now we translate the temporal diary into the the mobility diary</span>&nbsp;</span><span class="r"></span></p>
    <p id="t413" class="run"><span class="n"><a href="#t413">413</a></span><span class="t">        <span class="nam">prev</span><span class="op">,</span> <span class="nam">diary</span><span class="op">,</span> <span class="nam">other_count</span> <span class="op">=</span> <span class="nam">V</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span> <span class="op">[</span><span class="op">]</span><span class="op">,</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t414" class="run"><span class="n"><a href="#t414">414</a></span><span class="t">        <span class="nam">diary</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">[</span><span class="nam">current_date</span><span class="op">,</span> <span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t415" class="pln"><span class="n"><a href="#t415">415</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t416" class="run"><span class="n"><a href="#t416">416</a></span><span class="t">        <span class="key">for</span> <span class="nam">v</span> <span class="key">in</span> <span class="nam">V</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">:</span>  <span class="com"># scan all the states obtained and create the synthetic time series</span>&nbsp;</span><span class="r"></span></p>
    <p id="t417" class="run"><span class="n"><a href="#t417">417</a></span><span class="t">            <span class="nam">h</span><span class="op">,</span> <span class="nam">s</span> <span class="op">=</span> <span class="nam">v</span>&nbsp;</span><span class="r"></span></p>
    <p id="t418" class="run"><span class="n"><a href="#t418">418</a></span><span class="t">            <span class="nam">h_prev</span><span class="op">,</span> <span class="nam">s_prev</span> <span class="op">=</span> <span class="nam">prev</span>&nbsp;</span><span class="r"></span></p>
    <p id="t419" class="pln"><span class="n"><a href="#t419">419</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t420" class="run"><span class="n"><a href="#t420">420</a></span><span class="t">            <span class="key">if</span> <span class="nam">s</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>  <span class="com"># if in that hour she visits home</span>&nbsp;</span><span class="r"></span></p>
    <p id="t421" class="run"><span class="n"><a href="#t421">421</a></span><span class="t">                <span class="nam">current_date</span> <span class="op">+=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">timedelta</span><span class="op">(</span><span class="nam">hours</span><span class="op">=</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t422" class="run"><span class="n"><a href="#t422">422</a></span><span class="t">                <span class="nam">diary</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">[</span><span class="nam">current_date</span><span class="op">,</span> <span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t423" class="run"><span class="n"><a href="#t423">423</a></span><span class="t">                <span class="nam">other_count</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t424" class="pln"><span class="n"><a href="#t424">424</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>  <span class="com"># if in that hour she does NOT visit home</span>&nbsp;</span><span class="r"></span></p>
    <p id="t425" class="pln"><span class="n"><a href="#t425">425</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t426" class="run"><span class="n"><a href="#t426">426</a></span><span class="t">                <span class="key">if</span> <span class="nam">h</span> <span class="op">></span> <span class="nam">h_prev</span><span class="op">:</span>  <span class="com"># we are in the same day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t427" class="run"><span class="n"><a href="#t427">427</a></span><span class="t">                    <span class="nam">j</span> <span class="op">=</span> <span class="nam">h</span> <span class="op">-</span> <span class="nam">h_prev</span>&nbsp;</span><span class="r"></span></p>
    <p id="t428" class="pln"><span class="n"><a href="#t428">428</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>  <span class="com"># we are in the next day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t429" class="run"><span class="n"><a href="#t429">429</a></span><span class="t">                    <span class="nam">j</span> <span class="op">=</span> <span class="num">24</span> <span class="op">-</span> <span class="nam">h_prev</span> <span class="op">+</span> <span class="nam">h</span>&nbsp;</span><span class="r"></span></p>
    <p id="t430" class="pln"><span class="n"><a href="#t430">430</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t431" class="run"><span class="n"><a href="#t431">431</a></span><span class="t">                <span class="key">for</span> <span class="nam">i</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="num">0</span><span class="op">,</span> <span class="nam">j</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t432" class="run"><span class="n"><a href="#t432">432</a></span><span class="t">                    <span class="nam">current_date</span> <span class="op">+=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">timedelta</span><span class="op">(</span><span class="nam">hours</span><span class="op">=</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t433" class="run"><span class="n"><a href="#t433">433</a></span><span class="t">                    <span class="nam">diary</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">[</span><span class="nam">current_date</span><span class="op">,</span> <span class="nam">other_count</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t434" class="run"><span class="n"><a href="#t434">434</a></span><span class="t">                <span class="nam">other_count</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t435" class="pln"><span class="n"><a href="#t435">435</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t436" class="run"><span class="n"><a href="#t436">436</a></span><span class="t">            <span class="nam">prev</span> <span class="op">=</span> <span class="nam">v</span>&nbsp;</span><span class="r"></span></p>
    <p id="t437" class="pln"><span class="n"><a href="#t437">437</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t438" class="run"><span class="n"><a href="#t438">438</a></span><span class="t">        <span class="nam">short_diary</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t439" class="run"><span class="n"><a href="#t439">439</a></span><span class="t">        <span class="nam">prev_location</span> <span class="op">=</span> <span class="op">-</span><span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t440" class="run"><span class="n"><a href="#t440">440</a></span><span class="t">        <span class="key">for</span> <span class="nam">visit_date</span><span class="op">,</span> <span class="nam">abstract_location</span> <span class="key">in</span> <span class="nam">diary</span><span class="op">[</span><span class="num">0</span><span class="op">:</span> <span class="nam">diary_length</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t441" class="run"><span class="n"><a href="#t441">441</a></span><span class="t">            <span class="key">if</span> <span class="nam">abstract_location</span> <span class="op">!=</span> <span class="nam">prev_location</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t442" class="run"><span class="n"><a href="#t442">442</a></span><span class="t">                <span class="nam">short_diary</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">[</span><span class="nam">visit_date</span><span class="op">,</span> <span class="nam">abstract_location</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t443" class="run"><span class="n"><a href="#t443">443</a></span><span class="t">            <span class="nam">prev_location</span> <span class="op">=</span> <span class="nam">abstract_location</span>&nbsp;</span><span class="r"></span></p>
    <p id="t444" class="pln"><span class="n"><a href="#t444">444</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t445" class="run"><span class="n"><a href="#t445">445</a></span><span class="t">        <span class="nam">diary_df</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">DataFrame</span><span class="op">(</span><span class="nam">short_diary</span><span class="op">,</span> <span class="nam">columns</span><span class="op">=</span><span class="op">[</span><span class="nam">date_time</span><span class="op">,</span> <span class="str">'abstract_location'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t446" class="run"><span class="n"><a href="#t446">446</a></span><span class="t">        <span class="key">return</span> <span class="nam">diary_df</span>&nbsp;</span><span class="r"></span></p>
</div>
<div id="footer">
    <div class="content">
        <p>
            <a class="nav" href="index.html">&#xab; index</a> &nbsp; &nbsp; <a class="nav" href="https://coverage.readthedocs.io">coverage.py v5.5</a>,
            created at 2023-01-20 17:46 +0000
        </p>
    </div>
</div>
</body>
</html>
